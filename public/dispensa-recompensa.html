<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispensa por Bons Servicos - PlattArgus</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--bg-primary:#0a0e14;--bg-secondary:#111820;--bg-tertiary:#1a222d;--bg-card:#141c26;--accent:#e63946;--accent-hover:#ff4d5a;--accent-glow:rgba(230,57,70,0.4);--text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--success:#10b981;--warning:#f59e0b;--error:#ef4444;--info:#3b82f6;--border-color:rgba(255,255,255,0.08);--font-display:'Plus Jakarta Sans',sans-serif}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:var(--font-display);background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.6}
        body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(230,57,70,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(230,57,70,0.03) 1px,transparent 1px);background-size:50px 50px;pointer-events:none;z-index:-1}

        .header{background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:12px 24px;position:sticky;top:0;z-index:100}
        .header-content{max-width:1600px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
        .logo{display:flex;align-items:center;gap:10px;text-decoration:none}
        .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--accent) 0%,#b91c1c 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;box-shadow:0 0 20px var(--accent-glow)}
        .logo-text{font-weight:700;font-size:1.1rem;color:var(--text-primary)}
        .logo-text span{color:var(--accent)}
        .logo-subtitle{color:var(--text-muted);font-size:0.75rem;margin-left:10px;padding-left:10px;border-left:1px solid var(--border-color)}
        .btn-header{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:8px 16px;border-radius:8px;font-weight:500;font-size:0.85rem;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.2s;text-decoration:none}
        .btn-header:hover{border-color:var(--accent);color:var(--accent)}

        .container{max-width:1400px;margin:0 auto;padding:20px}

        /* Workflow Steps */
        .workflow-steps{display:flex;justify-content:center;gap:20px;margin-bottom:30px}
        .step{display:flex;align-items:center;gap:10px;padding:12px 20px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;opacity:0.5;transition:all 0.3s}
        .step.active{opacity:1;border-color:var(--accent);background:rgba(230,57,70,0.1)}
        .step.completed{opacity:1;border-color:var(--success);background:rgba(16,185,129,0.1)}
        .step-number{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;background:var(--bg-tertiary);color:var(--text-muted)}
        .step.active .step-number{background:var(--accent);color:#fff}
        .step.completed .step-number{background:var(--success);color:#fff}
        .step-label{font-weight:600;font-size:0.85rem}
        .step-arrow{color:var(--text-muted);font-size:1.2rem}

        .panel{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-bottom:20px}
        .panel h2{color:var(--accent);margin-bottom:20px;font-size:1.1rem;display:flex;align-items:center;gap:10px}
        .panel h3{color:var(--text-primary);margin:20px 0 15px;font-size:0.95rem}

        .form-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:20px}
        .form-group{margin-bottom:0}
        .form-label{display:block;font-size:0.85rem;font-weight:500;margin-bottom:6px;color:var(--text-secondary)}
        .form-input,.form-select,.form-textarea{width:100%;padding:12px 14px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:0.9rem;font-family:var(--font-display);transition:all 0.2s}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
        .form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
        .form-hint{font-size:0.75rem;color:var(--text-muted);margin-top:4px}
        input[type="date"]{cursor:pointer}
        input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1);cursor:pointer;opacity:0.7}
        input[type="date"]::-webkit-calendar-picker-indicator:hover{opacity:1}

        .required::after{content:" *";color:var(--error)}

        .btn{padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.9rem;transition:all 0.2s;font-family:var(--font-display);display:inline-flex;align-items:center;gap:8px}
        .btn-primary{background:linear-gradient(135deg,var(--accent),#b91c1c);color:#fff;box-shadow:0 4px 15px var(--accent-glow)}
        .btn-primary:hover{transform:translateY(-1px)}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color)}
        .btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
        .btn-success{background:var(--success);color:#fff}
        .btn-success:hover{background:#0ea66d}
        .btn-lg{padding:14px 28px;font-size:1rem}

        .status{padding:12px 16px;border-radius:8px;margin:15px 0;font-size:0.9rem}
        .status-success{background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);color:var(--success)}
        .status-error{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:var(--error)}
        .status-loading{background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:var(--info);display:flex;align-items:center;gap:10px}
        .status-info{background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:var(--info)}

        .spinner{width:18px;height:18px;border:2px solid var(--border-color);border-top-color:currentColor;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        .hidden{display:none!important}

        /* Autocomplete */
        .autocomplete-wrapper{position:relative}
        .autocomplete-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;max-height:200px;overflow-y:auto;z-index:50;margin-top:4px;box-shadow:0 10px 25px rgba(0,0,0,0.5)}
        .autocomplete-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border-color);transition:all 0.15s}
        .autocomplete-item:last-child{border-bottom:none}
        .autocomplete-item:hover{background:var(--bg-tertiary);border-left:3px solid var(--accent)}
        .autocomplete-item .nome{font-weight:600;color:var(--text-primary);font-size:0.9rem}
        .autocomplete-item .detalhe{font-size:0.8rem;color:var(--text-muted)}

        .militar-selecionado{margin-top:10px;padding:14px;background:var(--bg-tertiary);border-radius:8px;border:1px solid var(--success)}
        .militar-nome{font-weight:700;color:var(--success);font-size:1rem}
        .militar-detalhe{font-size:0.85rem;color:var(--text-muted);margin-top:4px}

        /* NUP Box */
        .nup-box{background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(16,185,129,0.05));border:2px solid var(--success);border-radius:10px;padding:16px;margin-bottom:20px}
        .nup-box-label{font-size:0.8rem;color:var(--success);font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:6px}
        .nup-box-valor{font-family:monospace;font-size:1.2rem;color:var(--text-primary);font-weight:700}

        /* Document Preview */
        .doc-tabs{display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap}
        .doc-tab{padding:10px 18px;background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-muted);cursor:pointer;font-size:0.85rem;font-weight:600;border-radius:8px;transition:all 0.2s;display:flex;align-items:center;gap:8px}
        .doc-tab:hover{color:var(--text-primary);border-color:var(--accent)}
        .doc-tab.active{color:var(--accent);border-color:var(--accent);background:rgba(230,57,70,0.1)}
        .doc-tab .doc-number{width:22px;height:22px;border-radius:50%;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700}
        .doc-tab.active .doc-number{background:var(--accent);color:#fff}

        .preview-toolbar{display:flex;gap:4px;flex-wrap:wrap;padding:10px;background:var(--bg-primary);border-radius:8px 8px 0 0;border:1px solid var(--border-color);border-bottom:none}
        .toolbar-btn{padding:8px 12px;border:1px solid var(--border-color);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;border-radius:4px;font-size:0.85rem;transition:all 0.2s;min-width:36px;text-align:center}
        .toolbar-btn:hover{background:var(--bg-secondary);border-color:var(--accent);color:var(--accent)}
        .toolbar-separator{width:1px;background:var(--border-color);margin:0 6px}

        .preview-doc{background:#fff;color:#000;border-radius:0 0 8px 8px;padding:40px;font-family:'Times New Roman',serif;font-size:12pt;line-height:1.8;min-height:400px;max-height:600px;overflow-y:auto;border:1px solid var(--border-color)}
        .preview-doc:focus{outline:2px solid var(--success);outline-offset:-2px}

        .preview-hint{font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;display:flex;align-items:center;gap:8px}

        /* Actions */
        .actions-bar{display:flex;gap:12px;justify-content:center;margin-top:25px;padding-top:25px;border-top:1px solid var(--border-color)}

        /* Progress */
        .progress-container{margin:20px 0}
        .progress-bar{height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--success));border-radius:4px;transition:width 0.5s ease}
        .progress-text{font-size:0.85rem;color:var(--text-muted);text-align:center;margin-top:8px}

        /* Resultado Final */
        .resultado-final{background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(16,185,129,0.05));border:2px solid var(--success);border-radius:12px;padding:30px;text-align:center}
        .resultado-final h3{color:var(--success);font-size:1.3rem;margin-bottom:15px}
        .resultado-docs{display:flex;justify-content:center;gap:15px;flex-wrap:wrap;margin-top:20px}
        .resultado-doc{background:var(--bg-card);padding:15px 20px;border-radius:8px;border:1px solid var(--border-color)}
        .resultado-doc-tipo{font-size:0.8rem;color:var(--text-muted)}
        .resultado-doc-sei{font-family:monospace;font-weight:700;color:var(--text-primary);margin-top:5px}
        .resultado-doc-acoes{display:flex;gap:8px;margin-top:10px;justify-content:center}
        .btn-doc-acao{padding:6px 12px;border:1px solid var(--border-color);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;border-radius:6px;font-size:0.8rem;font-weight:500;transition:all 0.2s;display:flex;align-items:center;gap:5px}
        .btn-doc-acao:hover{border-color:var(--accent);color:var(--accent);background:rgba(230,57,70,0.1)}
        .btn-doc-acao.btn-assinar{background:var(--warning);color:#000;border-color:var(--warning)}
        .btn-doc-acao.btn-assinar:hover{background:#d97706;border-color:#d97706}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <a href="/" style="display:flex;align-items:center;gap:10px;text-decoration:none">
                    <div class="logo-icon"><i class="fas fa-fire"></i></div>
                    <div class="logo-text">Platt<span>Argus</span></div>
                </a>
                <span class="logo-subtitle">DISPENSA POR BONS SERVICOS</span>
            </div>
            <div style="display:flex;gap:12px">
                <a href="/" class="btn-header"><i class="fas fa-home"></i> Inicio</a>
                <a href="/nota-bg.html" class="btn-header"><i class="fas fa-newspaper"></i> Nota BG</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Workflow Steps -->
        <div class="workflow-steps">
            <div class="step active" id="step1">
                <span class="step-number">1</span>
                <span class="step-label">Preencher Dados</span>
            </div>
            <i class="fas fa-chevron-right step-arrow"></i>
            <div class="step" id="step2">
                <span class="step-number">2</span>
                <span class="step-label">Revisar Documentos</span>
            </div>
            <i class="fas fa-chevron-right step-arrow"></i>
            <div class="step" id="step3">
                <span class="step-number">3</span>
                <span class="step-label">Inserir no SEI</span>
            </div>
        </div>

        <!-- Etapa 1: Formulario -->
        <div id="etapa1">
            <div class="panel">
                <h2><i class="fas fa-edit"></i> Dados do Requerimento</h2>

                <div class="form-grid">
                    <!-- Militar -->
                    <div class="form-group" style="grid-column: span 2">
                        <label class="form-label required">Militar (Requerente)</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="militarBusca" class="form-input" placeholder="Digite matricula ou nome..." autocomplete="off">
                            <div id="militarDropdown" class="autocomplete-dropdown hidden"></div>
                        </div>
                        <div id="militarSelecionado" class="militar-selecionado hidden">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <div>
                                    <div id="militarNome" class="militar-nome">-</div>
                                    <div id="militarDetalhe" class="militar-detalhe">-</div>
                                </div>
                                <button class="btn btn-secondary" onclick="App.limparMilitar()" style="padding:6px 12px"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Quantidade de Dias -->
                    <div class="form-group">
                        <label class="form-label required">Quantidade de Dias</label>
                        <input type="number" id="dias" class="form-input" min="1" max="30" value="5" onchange="App.calcularDatas()">
                    </div>

                    <!-- Data Inicio -->
                    <div class="form-group">
                        <label class="form-label required">Data de Inicio</label>
                        <input type="date" id="dataInicio" class="form-input" onchange="App.calcularDatas()">
                    </div>

                    <!-- Data Apresentacao (calculada) -->
                    <div class="form-group">
                        <label class="form-label">Data de Apresentacao</label>
                        <input type="date" id="dataApresentacao" class="form-input" readonly>
                        <span class="form-hint">Calculada automaticamente</span>
                    </div>

                    <!-- Justificativa -->
                    <div class="form-group" style="grid-column: span 2">
                        <label class="form-label">Justificativa / Motivo</label>
                        <textarea id="justificativa" class="form-textarea" rows="3" placeholder="Ex: em reconhecimento aos bons servicos prestados durante a operacao..." style="resize:vertical"></textarea>
                    </div>
                </div>

                <h3><i class="fas fa-user-tie"></i> Dados do Comandante (Destinatario)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required">Nome do Comandante</label>
                        <input type="text" id="comandanteNome" class="form-input" placeholder="FULANO DE TAL" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Cargo</label>
                        <input type="text" id="comandanteCargo" class="form-input" placeholder="Comandante-Geral do CBMAC" value="Comandante-Geral do CBMAC">
                    </div>
                </div>

                <h3><i class="fas fa-folder-open"></i> Processo SEI</h3>
                <div id="nupSection">
                    <div id="nupAtivo" class="nup-box hidden">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div class="nup-box-label"><i class="fas fa-check-circle"></i> Processo Ativo</div>
                                <div class="nup-box-valor" id="nupAtivoValor">-</div>
                            </div>
                            <button class="btn btn-secondary" onclick="App.limparProcesso()" style="padding:6px 12px"><i class="fas fa-times"></i></button>
                        </div>
                    </div>

                    <div id="formNup" class="form-grid">
                        <div class="form-group">
                            <label class="form-label">NUP Existente</label>
                            <input type="text" id="nupExistente" class="form-input" placeholder="0609.012080.00000/2026-00">
                        </div>
                        <div class="form-group" style="display:flex;align-items:flex-end;gap:10px">
                            <button class="btn btn-secondary" onclick="App.usarNupExistente()" style="flex:1">
                                <i class="fas fa-link"></i> Usar NUP
                            </button>
                            <button class="btn btn-primary" onclick="App.criarProcesso()" id="btnCriarProc" style="flex:1">
                                <i class="fas fa-plus"></i> Criar Processo
                            </button>
                        </div>
                    </div>
                    <p class="form-hint">Tipo: Acesso à Informação: Boletim Geral</p>
                </div>

                <div id="statusEtapa1" class="status hidden"></div>

                <div class="actions-bar">
                    <button class="btn btn-primary btn-lg" onclick="App.irParaEtapa2()">
                        <i class="fas fa-arrow-right"></i> Gerar Documentos
                    </button>
                </div>
            </div>
        </div>

        <!-- Etapa 2: Preview Documentos -->
        <div id="etapa2" class="hidden">
            <div class="panel">
                <h2><i class="fas fa-eye"></i> Revisar Documentos</h2>

                <div id="nupResumo" class="nup-box">
                    <div class="nup-box-label"><i class="fas fa-folder"></i> Processo</div>
                    <div class="nup-box-valor" id="nupResumoValor">-</div>
                </div>

                <p class="preview-hint"><i class="fas fa-info-circle"></i> Clique em cada documento para revisar e editar antes de inserir no SEI.</p>

                <div class="doc-tabs">
                    <button class="doc-tab active" onclick="App.trocarDoc(1)">
                        <span class="doc-number">1</span> Requerimento
                    </button>
                    <button class="doc-tab" onclick="App.trocarDoc(2)">
                        <span class="doc-number">2</span> Nota para BG
                    </button>
                    <button class="doc-tab" onclick="App.trocarDoc(3)">
                        <span class="doc-number">3</span> Memorando
                    </button>
                </div>

                <div class="preview-toolbar">
                    <button type="button" class="toolbar-btn" onclick="App.formatDoc('bold')" title="Negrito"><b>N</b></button>
                    <button type="button" class="toolbar-btn" onclick="App.formatDoc('italic')" title="Italico"><i>I</i></button>
                    <button type="button" class="toolbar-btn" onclick="App.formatDoc('underline')" title="Sublinhado"><u>S</u></button>
                    <div class="toolbar-separator"></div>
                    <button type="button" class="toolbar-btn" onclick="App.formatDoc('justifyLeft')" title="Esquerda"><i class="fas fa-align-left"></i></button>
                    <button type="button" class="toolbar-btn" onclick="App.formatDoc('justifyCenter')" title="Centro"><i class="fas fa-align-center"></i></button>
                    <button type="button" class="toolbar-btn" onclick="App.formatDoc('justifyFull')" title="Justificar"><i class="fas fa-align-justify"></i></button>
                </div>

                <div id="previewDoc1" class="preview-doc" contenteditable="true"></div>
                <div id="previewDoc2" class="preview-doc hidden" contenteditable="true"></div>
                <div id="previewDoc3" class="preview-doc hidden" contenteditable="true"></div>

                <div id="statusEtapa2" class="status hidden"></div>

                <div class="actions-bar">
                    <button class="btn btn-secondary" onclick="App.voltarEtapa1()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-success btn-lg" onclick="App.inserirTodosSEI()" id="btnInserir">
                        <i class="fas fa-paper-plane"></i> Inserir 3 Documentos no SEI
                    </button>
                </div>
            </div>
        </div>

        <!-- Etapa 3: Progresso e Resultado -->
        <div id="etapa3" class="hidden">
            <div class="panel">
                <h2><i class="fas fa-upload"></i> Inserindo Documentos no SEI</h2>

                <div id="progressoContainer" class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <p class="progress-text" id="progressText">Preparando...</p>
                </div>

                <div id="resultadoFinal" class="resultado-final hidden">
                    <h3><i class="fas fa-check-circle"></i> Documentos Inseridos com Sucesso!</h3>
                    <div class="nup-box" style="display:inline-block">
                        <div class="nup-box-label"><i class="fas fa-folder"></i> Processo</div>
                        <div class="nup-box-valor" id="nupFinalValor">-</div>
                    </div>

                    <div class="resultado-docs" id="resultadoDocs">
                        <!-- Preenchido dinamicamente -->
                    </div>

                    <div style="margin-top:30px">
                        <a href="/" class="btn btn-primary btn-lg"><i class="fas fa-home"></i> Voltar ao Inicio</a>
                    </div>
                </div>

                <div id="statusEtapa3" class="status hidden"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const MILITAR_API = '/api/militar';

        const App = {
            token: localStorage.getItem('plattargus_token'),
            nupAtual: null,
            militarSelecionado: null,
            resultadosBusca: [],
            documentos: { doc1: '', doc2: '', doc3: '' },
            docAtual: 1,

            init() {
                if (!this.token) {
                    window.location.href = '/';
                    return;
                }

                // Data padrao (amanha)
                const amanha = new Date();
                amanha.setDate(amanha.getDate() + 1);
                document.getElementById('dataInicio').value = amanha.toISOString().split('T')[0];
                this.calcularDatas();

                // Autocomplete
                let debounce;
                document.getElementById('militarBusca').addEventListener('input', (e) => {
                    clearTimeout(debounce);
                    debounce = setTimeout(() => this.buscarMilitar(e.target.value), 300);
                });

                // Fechar dropdown
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#militarBusca') && !e.target.closest('#militarDropdown')) {
                        document.getElementById('militarDropdown').classList.add('hidden');
                    }
                });
            },

            calcularDatas() {
                const dataInicio = document.getElementById('dataInicio').value;
                const dias = parseInt(document.getElementById('dias').value) || 5;

                if (dataInicio) {
                    const d = new Date(dataInicio);
                    d.setDate(d.getDate() + dias);
                    document.getElementById('dataApresentacao').value = d.toISOString().split('T')[0];
                }
            },

            // ==================== MILITAR ====================

            async buscarMilitar(termo) {
                if (!termo || termo.length < 2) {
                    document.getElementById('militarDropdown').classList.add('hidden');
                    return;
                }

                try {
                    const resp = await fetch(`${MILITAR_API}/buscar?q=${encodeURIComponent(termo)}&limit=10`);
                    const data = await resp.json();
                    const dropdown = document.getElementById('militarDropdown');

                    const resultados = data.resultados || data.militares || [];
                    if (resultados.length > 0) {
                        this.resultadosBusca = resultados;
                        dropdown.innerHTML = resultados.map((m, i) => `
                            <div class="autocomplete-item" onclick="App.selecionarMilitar(${i})">
                                <div class="nome">${m.formatado || m.nome}</div>
                                <div class="detalhe">${m.lotacao || ''} | Mat: ${m.matricula_completa || m.matricula}</div>
                            </div>
                        `).join('');
                        dropdown.classList.remove('hidden');
                    } else {
                        dropdown.innerHTML = '<div style="padding:15px;text-align:center;color:var(--text-muted)">Nenhum encontrado</div>';
                        dropdown.classList.remove('hidden');
                    }
                } catch (err) {
                    console.error('Erro buscar militar:', err);
                }
            },

            selecionarMilitar(index) {
                const m = this.resultadosBusca[index];
                this.militarSelecionado = m;

                document.getElementById('militarBusca').classList.add('hidden');
                document.getElementById('militarDropdown').classList.add('hidden');
                document.getElementById('militarSelecionado').classList.remove('hidden');
                document.getElementById('militarNome').textContent = m.formatado || m.nome;
                document.getElementById('militarDetalhe').textContent = `Matricula: ${m.matricula_completa || m.matricula} | ${m.lotacao || ''}`;
            },

            limparMilitar() {
                this.militarSelecionado = null;
                document.getElementById('militarBusca').value = '';
                document.getElementById('militarBusca').classList.remove('hidden');
                document.getElementById('militarSelecionado').classList.add('hidden');
            },

            // ==================== PROCESSO/NUP ====================

            async criarProcesso() {
                const btn = document.getElementById('btnCriarProc');
                const status = document.getElementById('statusEtapa1');

                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Criando...';
                status.className = 'status status-loading';
                status.innerHTML = '<span class="spinner"></span> Criando processo no SEI...';
                status.classList.remove('hidden');

                try {
                    const resp = await fetch(API_URL + '/processos/criar', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({ tipo_processo: 'Acesso à Informação: Boletim Geral' })
                    });
                    const data = await resp.json();

                    if (data.sucesso || data.ok) {
                        const nup = data.nup || data.resultado?.nup;
                        this.setNupAtivo(nup);
                        status.className = 'status status-success';
                        status.innerHTML = '<i class="fas fa-check"></i> Processo criado!';
                        setTimeout(() => status.classList.add('hidden'), 3000);
                    } else {
                        throw new Error(data.erro || data.error || 'Erro ao criar processo');
                    }
                } catch (err) {
                    status.className = 'status status-error';
                    status.innerHTML = '<i class="fas fa-times"></i> ' + err.message;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-plus"></i> Criar Processo';
                }
            },

            usarNupExistente() {
                const nup = document.getElementById('nupExistente').value.trim();
                if (!nup) {
                    alert('Digite o NUP do processo');
                    return;
                }
                if (!nup.match(/\d{4}\.\d{6}\.\d{5}\/\d{4}-\d{2}/)) {
                    alert('Formato de NUP invalido. Use: 0609.012080.00000/2025-00');
                    return;
                }
                this.setNupAtivo(nup);
            },

            setNupAtivo(nup) {
                this.nupAtual = nup;
                document.getElementById('nupAtivoValor').textContent = nup;
                document.getElementById('nupAtivo').classList.remove('hidden');
                document.getElementById('formNup').classList.add('hidden');
            },

            limparProcesso() {
                this.nupAtual = null;
                document.getElementById('nupAtivo').classList.add('hidden');
                document.getElementById('formNup').classList.remove('hidden');
                document.getElementById('nupExistente').value = '';
            },

            // ==================== ETAPAS ====================

            irParaEtapa2() {
                // Validacoes
                if (!this.militarSelecionado) {
                    alert('Selecione o militar requerente');
                    return;
                }
                if (!this.nupAtual) {
                    alert('Informe ou crie um processo (NUP) primeiro');
                    return;
                }
                if (!document.getElementById('comandanteNome').value.trim()) {
                    alert('Informe o nome do Comandante');
                    return;
                }

                // Gerar documentos
                this.gerarDocumentos();

                // Atualizar UI
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step1').classList.add('completed');
                document.getElementById('step2').classList.add('active');

                document.getElementById('etapa1').classList.add('hidden');
                document.getElementById('etapa2').classList.remove('hidden');

                document.getElementById('nupResumoValor').textContent = this.nupAtual;
            },

            voltarEtapa1() {
                document.getElementById('step1').classList.add('active');
                document.getElementById('step1').classList.remove('completed');
                document.getElementById('step2').classList.remove('active');

                document.getElementById('etapa1').classList.remove('hidden');
                document.getElementById('etapa2').classList.add('hidden');
            },

            gerarDocumentos() {
                const m = this.militarSelecionado;
                const dias = parseInt(document.getElementById('dias').value) || 5;
                const diasExtenso = this.numeroPorExtenso(dias);
                const dataInicio = document.getElementById('dataInicio').value;
                const dataApresentacao = document.getElementById('dataApresentacao').value;
                const justificativa = document.getElementById('justificativa').value.trim();
                const comandanteNome = document.getElementById('comandanteNome').value.trim();
                const comandanteCargo = document.getElementById('comandanteCargo').value.trim();

                // DOC 1: Requerimento
                this.documentos.doc1 = `
                    <p style="text-align: left;">Ao Senhor<br>
                    <b>${comandanteNome}</b><br>
                    ${comandanteCargo}</p>

                    <p style="text-align: left;">Assunto: <b>Dispensa por Bons Servicos Prestados</b></p>

                    <p style="text-align: left; text-indent: 1.5cm;">Senhor Comandante,</p>

                    <p style="text-align: justify; text-indent: 1.5cm;">Eu, ${m.nome}, ${m.posto_grad || m.posto}, matricula no ${m.matricula_completa || m.matricula}, lotado(a) no(a) ${m.lotacao || 'CBMAC'}, venho, respeitosamente, a presenca de Vossa Senhoria requerer <b>DISPENSA DE ${dias} (${diasExtenso.toUpperCase()}) DIA(S)</b>, a contar do dia ${this.formatarDataBR(dataInicio)}, com base no Art. 65, inciso IV, da Lei Complementar no 164/2006 (Estatuto dos Militares do Estado do Acre), em reconhecimento aos bons servicos prestados a Corporacao.</p>

                    ${justificativa ? `<p style="text-align: justify; text-indent: 1.5cm;">${justificativa}</p>` : ''}

                    <p style="text-align: justify;">Nestes termos, Pede deferimento.</p>

                    <p style="text-align: left; text-indent: 1.5cm;">Atenciosamente,</p>

                    <p style="text-align: center;"><b>${m.nome} - ${m.posto_grad || m.posto}</b><br>
                    Matricula no ${m.matricula_completa || m.matricula}</p>
                `;

                // DOC 2: Nota para BG
                const categoria = this.detectarCategoria(m.posto_grad || m.posto);
                const secaoCategoria = categoria === 'OFICIAIS' ? '1. ALTERACOES DE OFICIAIS' :
                                       categoria === 'ST_SGT' ? '2.1. ALTERACOES DE SUBTENENTES E SARGENTOS' :
                                       categoria === 'CB_SD' ? '2.2. ALTERACOES DE CABOS E SOLDADOS' : '3. ALTERACOES DE SERVIDORES CIVIS';

                this.documentos.doc2 = `
                    <div style="text-align:center;margin-bottom:20px">
                        <p style="font-weight:bold">ESTADO DO ACRE</p>
                        <p style="font-weight:bold">CORPO DE BOMBEIROS MILITAR</p>
                        <p style="font-weight:bold">COMANDO GERAL</p>
                    </div>

                    <p style="text-align:center;font-weight:bold;margin:30px 0">
                        NOTA PARA BOLETIM GERAL - BG - CBMAC
                    </p>

                    <p style="text-align:center;font-weight:bold">1a P A R T E</p>
                    <p style="text-align:center">(ESCALA DE SERVICO)</p>
                    <p style="text-align:center;font-style:italic;margin-bottom:20px">Sem Alteracao</p>

                    <p style="text-align:center;font-weight:bold">2a P A R T E</p>
                    <p style="text-align:center">(INSTRUCAO)</p>
                    <p style="text-align:center;font-style:italic;margin-bottom:20px">Sem Alteracao</p>

                    <p style="text-align:center;font-weight:bold">3a P A R T E</p>
                    <p style="text-align:center;margin-bottom:20px">(ASSUNTOS GERAIS E ADMINISTRATIVOS)</p>

                    ${categoria === 'OFICIAIS' ? `
                        <p style="font-weight:bold">${secaoCategoria}</p>
                    ` : categoria === 'CIVIS' ? `
                        <p style="font-weight:bold">1. ALTERACOES DE OFICIAIS - Nao Houve</p>
                        <p style="font-weight:bold;margin-top:15px">2. ALTERACOES DE PRACAS - Nao Houve</p>
                        <p style="font-weight:bold;margin-top:15px">${secaoCategoria}</p>
                    ` : `
                        <p style="font-weight:bold">1. ALTERACOES DE OFICIAIS - Nao Houve</p>
                        <p style="font-weight:bold;margin-top:15px">2. ALTERACOES DE PRACAS</p>
                        <p style="font-weight:bold;margin-left:20px">${secaoCategoria}</p>
                    `}

                    <p style="margin-left:20px;margin-top:15px"><strong><u>a) DISPENSA COMO RECOMPENSA - CONCESSAO</u></strong></p>
                    <p style="margin-left:20px"><strong>Em ${this.formatarDataBR(dataInicio)},</strong></p>
                    <p style="margin-left:20px;text-align:justify">
                        Concedo, a contar da data acima, ${dias} (${diasExtenso}) dias de dispensa como recompensa,
                        ao ${m.posto_grad || m.posto} mat. ${m.matricula_completa || m.matricula} <strong>${m.nome}</strong>,
                        devendo apresentar-se no dia ${this.formatarDataBR(dataApresentacao)}.
                    </p>

                    ${categoria !== 'OFICIAIS' && categoria !== 'CIVIS' ? `
                        ${categoria === 'ST_SGT' ? '<p style="margin-left:20px;margin-top:10px">2.2. ALTERACOES DE CABOS E SOLDADOS - Nao Houve</p>' :
                          '<p style="margin-left:20px;margin-top:10px">2.1. ALTERACOES DE SUBTENENTES E SARGENTOS - Nao Houve</p>'}
                        <p style="font-weight:bold;margin-top:15px">3. ALTERACOES DE SERVIDORES CIVIS - Nao Houve</p>
                    ` : categoria === 'OFICIAIS' ? `
                        <p style="font-weight:bold;margin-top:15px">2. ALTERACOES DE PRACAS - Nao Houve</p>
                        <p style="font-weight:bold;margin-top:15px">3. ALTERACOES DE SERVIDORES CIVIS - Nao Houve</p>
                    ` : ''}

                    <p style="font-weight:bold;margin-top:15px">4. ASSUNTOS GERAIS - Nao Houve</p>

                    <p style="text-align:center;font-weight:bold;margin-top:30px">4a P A R T E</p>
                    <p style="text-align:center">(JUSTICA E DISCIPLINA)</p>
                    <p style="text-align:center;font-style:italic">Sem Alteracao</p>

                    <div style="text-align:center;margin-top:50px">
                        <p><strong>${comandanteNome}</strong></p>
                        <p>${comandanteCargo}</p>
                    </div>
                `;

                // DOC 3: Memorando de Encaminhamento
                this.documentos.doc3 = `
                    <p style="text-align: left;">Ao(A) Sr(a). <b>${comandanteNome}</b><br>
                    ${comandanteCargo}</p>

                    <p style="text-align: left; text-indent: 1.5cm;">Senhor Comandante,</p>

                    <p style="text-align: justify; text-indent: 1.5cm;">Com os cumprimentos de estilo, encaminho a Vossa Senhoria os documentos anexos para conhecimento e providencias decorrentes, em face do requerimento de dispensa por bons servicos prestados do(a) ${m.posto_grad || m.posto} mat. ${m.matricula_completa || m.matricula} <strong>${m.nome}</strong>, conforme processo SEI no ${this.nupAtual}.</p>

                    <p style="text-align: left; text-indent: 1.5cm;">Atenciosamente,</p>

                    <p style="text-align: center;"><b>Nome do Remetente</b><br>
                    Cargo/Funcao</p>
                `;

                // Renderizar primeiro documento
                document.getElementById('previewDoc1').innerHTML = this.documentos.doc1;
                document.getElementById('previewDoc2').innerHTML = this.documentos.doc2;
                document.getElementById('previewDoc3').innerHTML = this.documentos.doc3;
            },

            trocarDoc(num) {
                // Salvar HTML atual
                this.documentos[`doc${this.docAtual}`] = document.getElementById(`previewDoc${this.docAtual}`).innerHTML;

                // Atualizar tabs
                document.querySelectorAll('.doc-tab').forEach((t, i) => {
                    t.classList.toggle('active', i === num - 1);
                });

                // Mostrar documento
                [1, 2, 3].forEach(n => {
                    document.getElementById(`previewDoc${n}`).classList.toggle('hidden', n !== num);
                });

                this.docAtual = num;
            },

            formatDoc(command) {
                document.execCommand(command, false, null);
                document.getElementById(`previewDoc${this.docAtual}`).focus();
            },

            // ==================== INSERIR SEI ====================

            async inserirTodosSEI() {
                // Salvar documentos editados
                [1, 2, 3].forEach(n => {
                    this.documentos[`doc${n}`] = document.getElementById(`previewDoc${n}`).innerHTML;
                });

                // Atualizar UI
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step2').classList.add('completed');
                document.getElementById('step3').classList.add('active');

                document.getElementById('etapa2').classList.add('hidden');
                document.getElementById('etapa3').classList.remove('hidden');

                const progress = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const resultados = [];

                // Funcao auxiliar para verificar se erro e apenas de captura (doc foi inserido)
                const erroApenasCaptura = (erro) => {
                    if (!erro) return false;
                    const msg = erro.toLowerCase();
                    return msg.includes('não capturado') || msg.includes('nao capturado') ||
                           msg.includes('cabeçalho') || msg.includes('cabecalho');
                };

                try {
                    // DOC 1: Requerimento
                    progressText.textContent = 'Inserindo Requerimento (1/3)...';
                    progress.style.width = '15%';

                    const resp1 = await fetch(API_URL + '/processos/inserir-sei', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            nup: this.nupAtual,
                            tipo_documento: 'Requerimento',
                            html: this.documentos.doc1
                        })
                    });
                    const data1 = await resp1.json();
                    const erro1 = data1.erro || data1.error || '';
                    if (!data1.sucesso && !data1.ok && !erroApenasCaptura(erro1)) {
                        throw new Error('Erro ao inserir Requerimento: ' + erro1);
                    }
                    const sei1 = data1.sei_numero || data1.numero_sei || data1.sei_numero_arvore || null;
                    resultados.push({ tipo: 'Requerimento', sei: sei1, ok: true });
                    progress.style.width = '35%';

                    // DOC 2: Nota BG
                    progressText.textContent = 'Inserindo Nota para BG (2/3)...';

                    const resp2 = await fetch(API_URL + '/nota-bg/inserir', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            nup: this.nupAtual,
                            html: this.documentos.doc2
                        })
                    });
                    const data2 = await resp2.json();
                    const erro2 = data2.erro || data2.error || '';
                    if (!data2.sucesso && !data2.ok && !erroApenasCaptura(erro2)) {
                        throw new Error('Erro ao inserir Nota BG: ' + erro2);
                    }
                    const sei2 = data2.sei_numero || data2.numero_sei || data2.sei_numero_arvore || null;
                    resultados.push({ tipo: 'Nota para BG', sei: sei2, ok: true });
                    progress.style.width = '65%';

                    // DOC 3: Memorando
                    progressText.textContent = 'Inserindo Memorando (3/3)...';

                    const resp3 = await fetch(API_URL + '/processos/inserir-sei', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            nup: this.nupAtual,
                            tipo_documento: 'Memorando',
                            html: this.documentos.doc3
                        })
                    });
                    const data3 = await resp3.json();
                    const erro3 = data3.erro || data3.error || '';
                    if (!data3.sucesso && !data3.ok && !erroApenasCaptura(erro3)) {
                        throw new Error('Erro ao inserir Memorando: ' + erro3);
                    }
                    const sei3 = data3.sei_numero || data3.numero_sei || data3.sei_numero_arvore || null;
                    resultados.push({ tipo: 'Memorando', sei: sei3, ok: true });
                    progress.style.width = '100%';

                    // Sucesso!
                    progressText.textContent = 'Concluido!';
                    document.getElementById('progressoContainer').classList.add('hidden');
                    document.getElementById('resultadoFinal').classList.remove('hidden');
                    document.getElementById('nupFinalValor').textContent = this.nupAtual;

                    document.getElementById('resultadoDocs').innerHTML = resultados.map(r => `
                        <div class="resultado-doc">
                            <div class="resultado-doc-tipo">${r.tipo}</div>
                            <div class="resultado-doc-sei">${r.sei ? 'SEI nº ' + r.sei : 'Inserido'}</div>
                            ${r.sei ? `
                                <div class="resultado-doc-acoes">
                                    <button class="btn-doc-acao" onclick="App.verDocumento('${r.sei}')" title="Ver Documento">
                                        <i class="fas fa-file-alt"></i> Ver
                                    </button>
                                    <button class="btn-doc-acao btn-assinar" onclick="App.assinarDocumento('${r.sei}')" title="Assinar">
                                        <i class="fas fa-signature"></i> Assinar
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');

                    // Salva resultados para uso posterior
                    this.resultadosInseridos = resultados;

                } catch (err) {
                    const status = document.getElementById('statusEtapa3');
                    status.className = 'status status-error';
                    status.innerHTML = '<i class="fas fa-times"></i> ' + err.message;
                    status.classList.remove('hidden');
                    progressText.textContent = 'Erro!';
                }
            },

            // ==================== UTILS ====================

            detectarCategoria(postoGrad) {
                if (!postoGrad) return 'CIVIS';
                const pg = postoGrad.toUpperCase();
                if (/CEL|TC|MAJ|CAP|TEN/.test(pg)) return 'OFICIAIS';
                if (/ST|SGT|SUBTENENTE|SARGENTO/.test(pg)) return 'ST_SGT';
                if (/CB|SD|CABO|SOLDADO/.test(pg)) return 'CB_SD';
                return 'CIVIS';
            },

            numeroPorExtenso(n) {
                const ext = ['zero','um','dois','tres','quatro','cinco','seis','sete','oito','nove','dez',
                    'onze','doze','treze','quatorze','quinze','dezesseis','dezessete','dezoito','dezenove','vinte',
                    'vinte e um','vinte e dois','vinte e tres','vinte e quatro','vinte e cinco','vinte e seis','vinte e sete','vinte e oito','vinte e nove','trinta'];
                return ext[n] || n.toString();
            },

            formatarDataBR(dataISO) {
                if (!dataISO) return '';
                const [ano, mes, dia] = dataISO.split('-');
                return `${dia}/${mes}/${ano}`;
            },

            // ==================== AÇÕES DOCUMENTO ====================

            verDocumento(seiNumero) {
                // Abre o documento no SEI em nova aba
                const url = `https://app.sei.ac.gov.br/sei/controlador.php?acao=documento_visualizar&id_documento=${seiNumero}`;
                window.open(url, '_blank');
            },

            async assinarDocumento(seiNumero) {
                if (!confirm(`Deseja assinar o documento SEI nº ${seiNumero}?`)) return;

                const status = document.getElementById('statusEtapa3');
                status.className = 'status status-loading';
                status.innerHTML = '<span class="spinner"></span> Assinando documento...';
                status.classList.remove('hidden');

                try {
                    const resp = await fetch(API_URL + '/processos/assinar', {
                        method: 'POST',
                        headers: this.getHeaders(),
                        body: JSON.stringify({
                            sei_numero: seiNumero
                        })
                    });
                    const data = await resp.json();

                    if (data.sucesso || data.ok) {
                        status.className = 'status status-success';
                        status.innerHTML = '<i class="fas fa-check"></i> Documento assinado com sucesso!';
                    } else {
                        throw new Error(data.erro || data.error || 'Erro ao assinar');
                    }
                } catch (err) {
                    status.className = 'status status-error';
                    status.innerHTML = '<i class="fas fa-times"></i> ' + err.message;
                }
            },

            getHeaders() {
                return {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + this.token,
                    'Accept': 'application/json'
                };
            }
        };

        App.init();
    </script>
</body>
</html>
